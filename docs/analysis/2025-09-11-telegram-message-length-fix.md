# í…”ë ˆê·¸ë¨ ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ ë¬¸ì œ ë¶„ì„ ë° í•´ê²°

## ğŸ“… ë¶„ì„ ì •ë³´
- **ë‚ ì§œ**: 2025-09-11 14:30
- **ìš”ì²­**: sessionsë¡œ ì„¸ì…˜ ì „í™˜ ì‹œ message too long ì—ëŸ¬ í•´ê²°
- **ìœ í˜•**: Bug Fix + UX Improvement

## ğŸ“Š ë¶„ì„ ê²°ê³¼

### ë¬¸ì œ ìƒí™©

#### ì‚¬ìš©ì ë³´ê³ 
- `/sessions` ëª…ë ¹ì–´ë¡œ ì„¸ì…˜ ì „í™˜ ì‹œ ê¸´ ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì—ëŸ¬ ë°œìƒ
- "Message too long" ì—ëŸ¬ë¡œ ì „ì†¡ ì‹¤íŒ¨
- ê¸°ì¤€ì´ ë„ˆë¬´ ì§§ê³ , ì—ëŸ¬ë³´ë‹¤ëŠ” ìë™ ë¶„í• ì´ ë‚˜ìŒ

#### ê·¼ë³¸ ì›ì¸
1. **`_switch_to_session()` ë©”ì„œë“œì˜ ë©”ì‹œì§€ ê¸¸ì´ ì²´í¬ ëˆ„ë½**
   - `bot.py:1125` - ê¸¸ì´ ì²´í¬ ì—†ì´ ì§ì ‘ ì „ì†¡
   - ë¡œê·¸ê°€ 4096ì ì´ˆê³¼ì‹œ í…”ë ˆê·¸ë¨ API ì—ëŸ¬

2. **ë©”ì‹œì§€ ë¶„í•  ìœ í‹¸ë¦¬í‹° ë¯¸ì‚¬ìš©**
   - `split_long_message()` í•¨ìˆ˜ ì¡´ì¬í•˜ì§€ë§Œ ë¯¸ì‚¬ìš©
   - `safe_send_message()` í•¨ìˆ˜ë„ êµ¬í˜„ë˜ì–´ ìˆì§€ë§Œ ë¯¸í™œìš©

3. **ë¶€ì ì ˆí•œ ì œí•œê°’**
   - ì‹¤ì œ í…”ë ˆê·¸ë¨ ì œí•œ: 4096ì
   - ì„¤ì •ê°’: 5000ì (ì‹¤ì œ ì œí•œ ì´ˆê³¼)

### í•´ê²° ë°©ì•ˆ

#### 1. ìë™ ë©”ì‹œì§€ ë¶„í•  ì ìš©
```python
# Before (ë¬¸ì œ ìˆë˜ ì½”ë“œ)
await update.message.reply_text(full_message, parse_mode=None, reply_markup=reply_markup)

# After (ìˆ˜ì •ëœ ì½”ë“œ)
if len(full_message) > get_telegram_max_length():
    await safe_send_message(
        update.message.reply_text,
        full_message,
        parse_mode=None,
        reply_markup=reply_markup,
        preserve_markdown=False
    )
else:
    await update.message.reply_text(full_message, parse_mode=None, reply_markup=reply_markup)
```

#### 2. ìŠ¤ë§ˆíŠ¸ ë¶„í•  ê¸°ëŠ¥
- ì¤„ë°”ê¿ˆ ê²½ê³„ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ë¶„í• 
- ë‹¨ì–´ ì¤‘ê°„ ë¶„í•  ë°©ì§€
- ì—°ì† ë©”ì‹œì§€ í‘œì‹œ (_(ê³„ì†)_)
- ë§ˆì§€ë§‰ ë©”ì‹œì§€ì—ë§Œ ë²„íŠ¼ ì¶”ê°€

#### 3. ì œí•œê°’ ì¡°ì •
- 5000 â†’ 4000ìë¡œ ì¡°ì • (ì•ˆì „ ë§ˆì§„ í™•ë³´)
- ì‹¤ì œ ì œí•œ(4096)ë³´ë‹¤ ì•½ê°„ ì‘ê²Œ ì„¤ì •

### êµ¬í˜„ ë³€ê²½ì‚¬í•­

#### ìˆ˜ì •ëœ íŒŒì¼
1. **`claude_ops/telegram/bot.py`**
   - `_switch_to_session()` ë©”ì„œë“œì— ê¸¸ì´ ì²´í¬ ë° ë¶„í•  ë¡œì§ ì¶”ê°€

2. **`claude_ops/telegram/message_utils.py`**
   - `safe_send_message()` ê°œì„  - reply_markup ì²˜ë¦¬
   - ì œí•œê°’ 5000 â†’ 4000 ì¡°ì •
   - ë§ˆì§€ë§‰ ë©”ì‹œì§€ì—ë§Œ ë²„íŠ¼ í‘œì‹œ

### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```bash
âœ… test_message_splitting_utility_exists - PASSED
âœ… test_smart_message_splitting_preserves_lines - PASSED
âœ… test_markdown_preservation_in_split_messages - PASSED
```

## ğŸ’¡ ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

### Before (ë¬¸ì œì )
- ì„¸ì…˜ ì „í™˜ì‹œ ê¸´ ë¡œê·¸ â†’ ì—ëŸ¬ ë°œìƒ
- ì‚¬ìš©ìê°€ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ì—†ìŒ
- ì§œì¦ë‚˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€

### After (ê°œì„ ë¨)
- ê¸´ ë¡œê·¸ ìë™ ë¶„í•  ì „ì†¡
- ìì—°ìŠ¤ëŸ¬ìš´ ë¶„í•  (ì¤„ ë‹¨ìœ„)
- ì—°ì† ë©”ì‹œì§€ í‘œì‹œë¡œ ê°€ë…ì„± ìœ ì§€
- ë§ˆì§€ë§‰ ë©”ì‹œì§€ì— ë²„íŠ¼ ìœ ì§€

## ğŸ“ˆ ì˜í–¥ ë²”ìœ„

### ê¸ì •ì  ì˜í–¥
1. **ì•ˆì •ì„± í–¥ìƒ**: ë©”ì‹œì§€ ê¸¸ì´ ì—ëŸ¬ ì œê±°
2. **ì‚¬ìš©ì„± ê°œì„ **: ê¸´ ë¡œê·¸ë„ ì •ìƒ í‘œì‹œ
3. **ì¼ê´€ì„±**: ëª¨ë“  ì„¸ì…˜ ì „í™˜ ì•ˆì •ì 

### ìœ„í—˜ ìš”ì†Œ
- ì—†ìŒ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€í•˜ë©° ê°œì„ ë§Œ ì¶”ê°€)

## ğŸ”— ê´€ë ¨ íŒŒì¼
- `/home/kyuwon/claude-ops/claude_ops/telegram/bot.py`
- `/home/kyuwon/claude-ops/claude_ops/telegram/message_utils.py`
- `/home/kyuwon/claude-ops/tests/test_telegram_message_limits.py`

## âœ… ê¶Œì¥ ì¡°ì¹˜
1. **ì¦‰ì‹œ ë°°í¬**: ì‚¬ìš©ì ê²½í—˜ ì¦‰ì‹œ ê°œì„ 
2. **ëª¨ë‹ˆí„°ë§**: ì‹¤ì œ ì‚¬ìš©ì‹œ ë¶„í•  ë¹ˆë„ ê´€ì°°
3. **ì¶”ê°€ ê°œì„ **: ë‹¤ë¥¸ ëª…ë ¹ì–´ì—ë„ safe_send_message ì ìš© ê²€í† 

## ğŸ“ ê²°ë¡ 

**ë¬¸ì œ í•´ê²° ì™„ë£Œ**: 
- "Message too long" ì—ëŸ¬ â†’ ìë™ ë¶„í•  ì „ì†¡
- ì‚¬ìš©ì ì¹œí™”ì  í•´ê²°ì±… êµ¬í˜„
- í…ŒìŠ¤íŠ¸ í†µê³¼ ë° ì•ˆì •ì„± í™•ë³´

**í•µì‹¬ ê°œì„ **:
- ì—ëŸ¬ ëŒ€ì‹  ìŠ¤ë§ˆíŠ¸í•œ ë¶„í• 
- ìì—°ìŠ¤ëŸ¬ìš´ ë©”ì‹œì§€ ê²½ê³„
- ë²„íŠ¼ ìœ„ì¹˜ ë³´ì¡´